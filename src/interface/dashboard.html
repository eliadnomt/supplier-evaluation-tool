<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Supplier Scorecard Tool</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap');
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', 'Avenir', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-weight: 300;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      background: white;
      color: #000;
      overflow-y: auto;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    header {
      text-align: center;
      margin-bottom: 60px;
    }
    h1 {
      font-size: 36px;
      font-weight: 300;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }
    .subtitle {
      font-size: 18px;
      font-weight: 300;
      color: #333;
    }
    .charts-section {
      display: flex;
      gap: 40px;
      justify-content: center;
      margin-bottom: 60px;
      flex-wrap: wrap;
    }
    .chart-container {
      flex: 1;
      min-width: 280px;
      max-width: 350px;
    }
    .chart-title {
      text-align: center;
      font-size: 16px;
      font-weight: 300;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }
    .chart-placeholder {
      width: 100%;
      height: 300px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fafafa;
      color: #999;
      font-size: 14px;
      text-transform: none;
      letter-spacing: 0.02em;
    }
    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      text-transform: none;
      letter-spacing: 0.02em;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .buttons-section {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 60px;
    }
    .btn {
      padding: 12px 30px;
      background: #e0e0e0;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      cursor: pointer;
      color: #000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: background 0.2s;
    }
    .btn:hover {
      background: #d0d0d0;
    }
    .description {
      max-width: 800px;
      margin: 0 auto 60px;
      text-align: left;
      line-height: 1.6;
      font-size: 14px;
      color: #333;
      text-transform: none;
      letter-spacing: 0.02em;
    }
    .description p {
      margin-bottom: 15px;
    }
    .powered-by {
      text-align: center;
      margin-bottom: 20px;
    }
    .powered-by-text {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }
    .logo-img {
      width: 120px;
      height: 120px;
      margin: 0 auto;
      display: block;
      object-fit: contain;
    }
    footer {
      text-align: center;
      padding-top: 40px;
      border-top: 1px solid #eee;
      color: #666;
      font-size: 12px;
      text-transform: none;
      letter-spacing: 0.02em;
    }
    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }
    .modal-overlay.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 40px 20px;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      margin: auto;
      padding: 30px;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover {
      color: #000;
    }
    .modal-content h2 {
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }
    .modal-content label {
      display: block;
      margin-top: 15px;
      font-size: 12px;
    }
    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      text-transform: none;
      letter-spacing: 0;
      font-weight: 300;
    }
    .modal-content input::placeholder {
      text-transform: none;
      letter-spacing: 0;
    }
    .modal-content h3 {
      margin-top: 25px;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }
    .material-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .material-row select,
    .material-row input {
      flex: 1;
      width: auto;
    }
    .remove-btn {
      padding: 8px 16px;
      background: #fee;
      color: #a00;
      border: 1px solid #a00;
      border-radius: 8px;
      cursor: pointer;
      font-size: 10px;
    }
    .add-btn {
      margin: 10px 0;
      padding: 8px 16px;
      background: #e0e0e0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 10px;
    }
    .warn {
      color: #a00;
      font-weight: 300;
      font-size: 12px;
      margin-top: 5px;
      text-transform: none;
      letter-spacing: normal;
    }
    #status {
      margin-top: 15px;
      color: #0b5;
      font-weight: 300;
      font-size: 12px;
      text-transform: none;
      letter-spacing: normal;
    }
    .suppliers-section {
      display: none;
      max-width: 1000px;
      margin: 40px auto 60px;
      padding: 30px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .suppliers-section.active {
      display: block;
    }
    .suppliers-section h3 {
      font-size: 18px;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      margin-bottom: 20px;
      text-align: center;
    }
    .suppliers-list {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 10px;
    }
    .supplier-item {
      padding: 15px;
      margin-bottom: 15px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
      position: relative;
    }
    .supplier-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: flex-end;
    }
    .supplier-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: opacity 0.2s;
    }
    .supplier-btn-edit {
      background: #e0e0e0;
      color: #000;
      border-radius: 8px;
    }
    .supplier-btn-edit:hover {
      background: #d0d0d0;
    }
    .supplier-btn-delete {
      background: #fee;
      color: #a00;
      border: 1px solid #a00;
      border-radius: 8px;
    }
    .supplier-btn-delete:hover {
      background: #fdd;
    }
    .supplier-item-header {
      font-size: 14px;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 10px;
      color: #000;
    }
    .supplier-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      font-size: 12px;
      text-transform: none;
      letter-spacing: 0.02em;
      color: #666;
    }
    .supplier-detail {
      display: flex;
      justify-content: space-between;
    }
    .supplier-detail-label {
      font-weight: 300;
      color: #999;
    }
    .suppliers-loading {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 12px;
      text-transform: none;
    }
    .suppliers-empty {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 12px;
      text-transform: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>SUPPLIER SCORECARD TOOL</h1>
      <p class="subtitle">Making responsible sourcing simpler</p>
    </header>

    <div class="charts-section">
      <div class="chart-container">
        <div class="chart-title">COTTON</div>
        <div class="chart-placeholder">Radar Chart Placeholder<br>(To be integrated)</div>
        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-dot" style="background: #87CEEB;"></div>
            <span>Supplier 1</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #4682B4;"></div>
            <span>Supplier 2</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #191970;"></div>
            <span>Supplier 3</span>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">WOOL</div>
        <div class="chart-placeholder">Radar Chart Placeholder<br>(To be integrated)</div>
        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-dot" style="background: #DDA0DD;"></div>
            <span>Supplier 1</span>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">SILK</div>
        <div class="chart-placeholder">Radar Chart Placeholder<br>(To be integrated)</div>
        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-dot" style="background: #FFD700;"></div>
            <span>Supplier 2</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #FF8C00;"></div>
            <span>Supplier 4</span>
          </div>
        </div>
      </div>
    </div>

    <div class="buttons-section">
      <button class="btn" id="addSupplierBtn">ADD SUPPLIER</button>
      <button class="btn" id="viewSuppliersBtn">VIEW SUPPLIERS</button>
    </div>

    <div class="suppliers-section" id="suppliersSection">
      <h3>Suppliers</h3>
      <div class="suppliers-list" id="suppliersList">
        <div class="suppliers-loading">Loading suppliers...</div>
      </div>
    </div>

    <div class="description">
      <p>This tool helps you compare material suppliers at a glance. Each radar chart shows how suppliers perform across five key factors: price, minimum order quantity, lead time, transparency and the Ecobalyse environmental score.</p>
      <p>The goal is not to find a single "perfect" supplier, but to make the trade-offs visible and easier to discuss.</p>
      <p>You can add suppliers, adjust assumptions and view them side by side to support responsible sourcing decisions.</p>
    </div>

    <div class="powered-by">
      <div class="powered-by-text">Powered with</div>
      <img src="/static/ecobalyse-logo.png" alt="Ecobalyse" class="logo-img" />
    </div>

    <footer>
      © 2025 – Site by Delia Montgomery
    </footer>
  </div>

  <!-- Modal for Add Supplier -->
  <div class="modal-overlay" id="addSupplierModal">
    <div class="modal-content">
      <button class="modal-close" id="closeModal">&times;</button>
      <h2>Enter Supplier Information</h2>
      <form id="supplierForm">
        <label>Supplier Name: <input name="supplier" required></label>
        <label>Business Size: <select name="businessSize" id="businessSizeSelect"></select></label>
        
        <label id="mat-origin-label">Material origin:</label>
        <div id="materialsSection"></div>
        <button type="button" class="add-btn" id="addMaterialBtn">Add Material</button>
        <div id="matOriginWarn" class="warn" style="display:none"></div>

        <h3>Country of origin</h3>
        <label>Spinning: <select name="countrySpinning" id="spinningCountrySelect"></select></label>
        <label>Fabric: <select name="countryFabric" id="fabricCountrySelect"></select></label>
        <label>Dyeing: <select name="countryDyeing" id="dyeingCountrySelect"></select></label>
        <label>Making: <select name="countryMaking" id="makingCountrySelect"></select></label>

        <h3>Fabric production specifications</h3>
        <label>Fabric Process: <select name="fabricProcess" id="fabricProcessSelect"></select></label>
        <label>Dyeing Process: <select name="dyeingProcess" id="dyeingProcessSelect"></select></label>
        <label>Making Complexity: <select name="makingComplexity" id="makingComplexitySelect"></select></label>
        <label>Gross fabric width (cm): <input name="gross_width" type="number" step="0.01" required></label>
        <label>Weight (g/m²): <input name="weight_gm2" type="number" step="0.1" required></label>
        <label>Price €/m: <input name="price_eur_per_m" type="number" step="0.01" required></label>
        <label>MOQ (m): <input name="moq_m" type="number" step="0.01" required></label>

        <h3>Production run specifications</h3>
        <label>Number of articles: <input name="numberOfReferences" type="number" required></label>
        <label>Price per article (€): <input name="price" type="number" step="0.01" required></label>
        
        <button type="submit" class="btn" style="margin-top: 20px;">Save Supplier</button>
        <div id="status"></div>
      </form>
    </div>
  </div>

  <script>
    // Modal control
    const modal = document.getElementById('addSupplierModal');
    const addBtn = document.getElementById('addSupplierBtn');
    const closeBtn = document.getElementById('closeModal');
    const viewBtn = document.getElementById('viewSuppliersBtn');

    addBtn.onclick = () => {
      // Reset form and remove edit mode
      document.getElementById('supplierForm').reset();
      document.getElementById('supplierForm').dataset.editIndex = '';
      document.getElementById('materialsSection').innerHTML = '';
      document.querySelector('.modal-content h2').textContent = 'Enter Supplier Information';
      document.getElementById('status').innerText = '';
      modal.classList.add('active');
      loadEnums();
    };

    closeBtn.onclick = () => {
      modal.classList.remove('active');
    };

    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
      }
    };

    const suppliersSection = document.getElementById('suppliersSection');
    const suppliersList = document.getElementById('suppliersList');
    
    viewBtn.onclick = () => {
      if (suppliersSection.classList.contains('active')) {
        suppliersSection.classList.remove('active');
      } else {
        suppliersSection.classList.add('active');
        loadSuppliers();
      }
    };

    function loadSuppliers() {
      suppliersList.innerHTML = '<div class="suppliers-loading">Loading suppliers...</div>';
      fetch('/api/suppliers/all').then(r=>r.json()).then(suppliers => {
        if (!suppliers || suppliers.length === 0) {
          suppliersList.innerHTML = '<div class="suppliers-empty">No suppliers found. Add a supplier to get started.</div>';
          return;
        }
        renderSuppliers(suppliers);
      }).catch(err => {
        suppliersList.innerHTML = '<div class="suppliers-empty">Error loading suppliers: ' + err + '</div>';
      });
    }

    function renderSuppliers(suppliers) {
      suppliersList.innerHTML = '';
      suppliers.forEach((supplier, index) => {
        const item = document.createElement('div');
        item.className = 'supplier-item';
        
        const header = document.createElement('div');
        header.className = 'supplier-item-header';
        header.textContent = supplier.supplier || 'Unnamed Supplier';
        item.appendChild(header);
        
        const details = document.createElement('div');
        details.className = 'supplier-details';
        
        const fields = [
          { label: 'Price €/m', value: supplier.price_eur_per_m },
          { label: 'MOQ (m)', value: supplier.moq_m },
          { label: 'Lead Time (weeks)', value: supplier.lead_time_weeks },
          { label: 'Weight (g/m²)', value: supplier.weight_gm2 },
          { label: 'Gross Width (cm)', value: supplier.gross_width },
          { label: 'Price per Article (€)', value: supplier.price },
          { label: 'Number of Articles', value: supplier.numberOfReferences },
          { label: 'Stock Service', value: supplier.stock_service ? 'Yes' : 'No' }
        ];
        
        fields.forEach(field => {
          if (field.value !== undefined && field.value !== null && field.value !== '') {
            const detail = document.createElement('div');
            detail.className = 'supplier-detail';
            const label = document.createElement('span');
            label.className = 'supplier-detail-label';
            label.textContent = field.label + ':';
            const value = document.createElement('span');
            value.textContent = typeof field.value === 'number' ? field.value.toLocaleString() : field.value;
            detail.appendChild(label);
            detail.appendChild(value);
            details.appendChild(detail);
          }
        });
        
        item.appendChild(details);
        
        // Add edit/delete buttons
        const actions = document.createElement('div');
        actions.className = 'supplier-actions';
        const editBtn = document.createElement('button');
        editBtn.className = 'supplier-btn supplier-btn-edit';
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => editSupplier(index, supplier);
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'supplier-btn supplier-btn-delete';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteSupplier(index, supplier.supplier);
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        item.appendChild(actions);
        
        suppliersList.appendChild(item);
      });
    }

    function deleteSupplier(index, supplierName) {
      if (confirm(`Are you sure you want to delete "${supplierName}"? This action cannot be undone.`)) {
        fetch(`/api/suppliers/${index}`, { method: 'DELETE' }).then(resp => {
          if (resp.ok) {
            loadSuppliers();
          } else {
            alert('Error deleting supplier');
          }
        }).catch(err => {
          alert('Error deleting supplier: ' + err);
        });
      }
    }

    function editSupplier(index, supplier) {
      // Store edit index
      document.getElementById('supplierForm').dataset.editIndex = index;
      
      // Pre-fill form with supplier data
      document.querySelector('input[name="supplier"]').value = supplier.supplier || '';
      if (supplier.businessSize) {
        document.getElementById('businessSizeSelect').value = supplier.businessSize;
      }
      
      // Fill country selects
      if (supplier.countrySpinning) document.getElementById('spinningCountrySelect').value = supplier.countrySpinning;
      if (supplier.countryFabric) document.getElementById('fabricCountrySelect').value = supplier.countryFabric;
      if (supplier.countryDyeing) document.getElementById('dyeingCountrySelect').value = supplier.countryDyeing;
      if (supplier.countryMaking) document.getElementById('makingCountrySelect').value = supplier.countryMaking;
      
      // Fill production specs
      if (supplier.fabricProcess) document.getElementById('fabricProcessSelect').value = supplier.fabricProcess;
      if (supplier.dyeingProcess) document.getElementById('dyeingProcessSelect').value = supplier.dyeingProcess;
      if (supplier.makingComplexity) document.getElementById('makingComplexitySelect').value = supplier.makingComplexity;
      if (supplier.gross_width) document.querySelector('input[name="gross_width"]').value = supplier.gross_width;
      if (supplier.weight_gm2) document.querySelector('input[name="weight_gm2"]').value = supplier.weight_gm2;
      if (supplier.price_eur_per_m) document.querySelector('input[name="price_eur_per_m"]').value = supplier.price_eur_per_m;
      if (supplier.moq_m) document.querySelector('input[name="moq_m"]').value = supplier.moq_m;
      if (supplier.numberOfReferences) document.querySelector('input[name="numberOfReferences"]').value = supplier.numberOfReferences;
      if (supplier.price) document.querySelector('input[name="price"]').value = supplier.price;
      
      // Update modal title
      document.querySelector('.modal-content h2').textContent = 'Edit Supplier Information';
      
      // Open modal
      modal.classList.add('active');
      loadEnums();
      
      // Fill material_origin after materials data loads
      const materialsSection = document.getElementById('materialsSection');
      materialsSection.innerHTML = '';
      if (supplier.material_origin && Array.isArray(supplier.material_origin)) {
        fetchMaterialEnums(() => {
          supplier.material_origin.forEach(mat => {
            createMaterialRow(mat);
          });
          updateMatSharesSum();
        });
      }
    }

    // Form functions (from supplier_form.html)
    function fillSelect(id, url, nameAttr=false) {
      fetch(url).then(r=>r.json()).then(arr => {
        const s = document.getElementById(id);
        if (!s) return;
        s.innerHTML = '';
        for (const v of arr) {
          let val = v;
          if (typeof(v)==='object') val = v.id || v.name || JSON.stringify(v);
          let label = val;
          if (typeof(v)==='object' && v.name) label = v.name;
          let opt = document.createElement('option');
          opt.value = val;
          opt.text = label;
          if(nameAttr && v.name) opt.text = v.name;
          s.appendChild(opt);
        }
      });
    }

    let materialsData = [];
    let spinningData = [];

    function fetchMaterialEnums(callback) {
      let done = 0;
      fetch('/api/enums/materials').then(r=>r.json()).then(arr => { materialsData = arr; checkReady(); });
      fetch('/api/enums/materialSpinning').then(r=>r.json()).then(arr => { spinningData = arr; checkReady(); });
      function checkReady() { done++; if(done===2 && callback) callback(); }
    }

    function createMaterialRow(rowData) {
      const row = document.createElement('div');
      row.className = 'material-row';
      const matSel = document.createElement('select');
      for (const m of materialsData) {
        let val = (typeof m === 'object' ? m.id || m.name || JSON.stringify(m) : m);
        let label = (typeof m === 'object' && m.name) ? m.name : val;
        let opt = document.createElement('option');
        opt.value = val;
        opt.text = label;
        matSel.appendChild(opt);
      }
      matSel.value = rowData && rowData.id ? rowData.id : (matSel.options[0]?.value || '');
      row.appendChild(matSel);
      const shareInput = document.createElement('input');
      shareInput.type = 'number';
      shareInput.min = 0.01;
      shareInput.max = 1;
      shareInput.step = 0.01;
      shareInput.value = rowData && rowData.share ? rowData.share : '';
      shareInput.placeholder = 'share (0-1)';
      row.appendChild(shareInput);
      const spinSel = document.createElement('select');
      for (const s of spinningData) {
        const opt = document.createElement('option');
        opt.value = s;
        opt.text = s;
        spinSel.appendChild(opt);
      }
      spinSel.value = rowData && rowData.spinning ? rowData.spinning : 'ConventionalSpinning';
      row.appendChild(spinSel);
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.innerText = 'Remove';
      removeBtn.className = 'remove-btn';
      removeBtn.onclick = function() {
        row.remove();
        updateMatSharesSum();
      };
      row.appendChild(removeBtn);
      document.getElementById('materialsSection').appendChild(row);
      shareInput.oninput = updateMatSharesSum;
    }

    function getMaterialOriginFromForm() {
      const rows = document.querySelectorAll('.material-row');
      let out = [];
      for (const row of rows) {
        const [matSel, shareInput, spinSel] = row.querySelectorAll('select, input');
        const shareVal = parseFloat(shareInput.value);
        if (!matSel.value || isNaN(shareVal) || !spinSel.value) continue;
        out.push({ id: matSel.value, share: shareVal, spinning: spinSel.value });
      }
      return out;
    }

    function updateMatSharesSum() {
      const orig = getMaterialOriginFromForm();
      const totalShare = orig.reduce((acc,v) => acc+v.share,0);
      const warn = document.getElementById('matOriginWarn');
      warn.style.display = (totalShare > 1.0001) ? '' : 'none';
      warn.innerText = totalShare > 1.0001 ? 'Total share of all materials must not exceed 1 (currently '+totalShare.toFixed(2)+').' : '';
      document.getElementById('addMaterialBtn').disabled = totalShare >= 1.0;
    }

    document.getElementById('addMaterialBtn').onclick = () => {
      if (materialsData.length === 0 || spinningData.length === 0) {
        fetchMaterialEnums(()=>{ createMaterialRow(); updateMatSharesSum(); });
      } else {
        createMaterialRow(); updateMatSharesSum();
      }
    };

    function loadEnums() {
      fillSelect('spinningCountrySelect', '/api/enums/countries');
      fillSelect('fabricCountrySelect', '/api/enums/countries');
      fillSelect('dyeingCountrySelect', '/api/enums/countries');
      fillSelect('makingCountrySelect', '/api/enums/countries');
      fillSelect('fabricProcessSelect', '/api/enums/fabricProcess');
      fillSelect('makingComplexitySelect', '/api/enums/makingComplexity');
      fillSelect('dyeingProcessSelect', '/api/enums/dyeingProcess');
      fillSelect('businessSizeSelect', '/api/enums/businessSize');
      fetchMaterialEnums(()=>{});
    }

    document.getElementById('supplierForm').onsubmit = function(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      let obj = {};
      for (let [k, v] of fd.entries()) {
        if (k === 'material_origin') continue;
        else if (k.endsWith('width') || k.endsWith('weight') || k.endsWith('price') || k.endsWith('moq') || k.endsWith('numberOfReferences')) { obj[k] = parseFloat(v); }
        else { obj[k] = v; }
      }
      obj['material_origin'] = getMaterialOriginFromForm();
      const totalShare = obj['material_origin'].reduce((acc, v) => acc + v.share, 0);
      if (totalShare > 1.0001 || obj['material_origin'].some(m => isNaN(m.share) || m.share < 0.01 || m.share > 1)) {
        document.getElementById('matOriginWarn').style.display = '';
        document.getElementById('matOriginWarn').innerText = 'Material shares total must not exceed 1 and all shares must be between 0.01 and 1.';
        return;
      }
      const editIndex = e.target.dataset.editIndex;
      const isEdit = editIndex !== undefined && editIndex !== '';
      const url = isEdit ? `/api/suppliers/${editIndex}` : '/api/suppliers';
      const method = isEdit ? 'PUT' : 'POST';
      
      fetch(url, { method: method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(obj)}).then(resp => {
        if (resp.ok) {
          document.getElementById('status').innerText = isEdit ? 'Supplier updated!' : 'Supplier saved!';
          // Reload suppliers list if it's visible
          if (suppliersSection.classList.contains('active')) {
            loadSuppliers();
          }
          setTimeout(() => {
            e.target.reset();
            e.target.dataset.editIndex = '';
            document.getElementById('materialsSection').innerHTML = '';
            document.getElementById('status').innerText = '';
            document.querySelector('.modal-content h2').textContent = 'Enter Supplier Information';
            modal.classList.remove('active');
          }, 1500);
        } else resp.text().then(t => document.getElementById('status').innerText = 'Error: '+t);
      });
    };
  </script>
</body>
</html>
